% !TeX spellcheck = cs_CZ
\documentclass[FM,MP]{tulthesis}

\usepackage[utf8]{inputenc}
\usepackage[czech]{babel}
\usepackage{tul}
\usepackage[hidelinks,unicode,hyperfootnotes=false]{hyperref}

\linespread{1.3}

\TULtitle{Validace konfiguračních souborů Flow123d}{Validation of Flow123d configuration files}
\TULprogramme{N2612}{Elektrotechnika a informatika}{Electrical Engineering and Informatics}
\TULbranch{1802T007}{Informační technologie}{Information Technologies}
\TULauthor{Bc.~Tomáš Křížek}
\TULsupervisor{Jiří Vraný,~Ph.D.}
\TULyear{2015}
\TULid{M14000168}

\begin{document}

\renewcommand{\thetable}{\arabic{table}}
\renewcommand{\thefigure}{\arabic{figure}}

\ThesisStart{male}

\begin{abstractCZ}
	Tento projekt se zabývá problematikou validace konfiguračních souborů Flow123d, jejichž struktura je dynamicky definována v závislosti na verzi Flow123D. V projektu jsou popsány specifika formátu konfiguračních souborů, jako jsou reference nebo automatické konverze. Dále je navržena datová struktura pro zpracování konfiguračních souborů a dynamicky definovaných validačních pravidel. Nakonec je rozebrána problematika samotné validace. 
\end{abstractCZ}
\vspace{2cm}
\begin{abstractEN}
	This project addresses the issues surrounding validation of Flow123d configuration files. Data structure of these files is dependent on the version of Flow123d. This paper describes the specifics of the configuration file format. These include references or automatic conversions. Next, a data structure for processing of configuration files and dynamycally defined validation rules is designed. Lastly, the issues of validation are discussed.
\end{abstractEN}

\tableofcontents
\clearpage

\begin{abbrList}
\textbf{JSON} & JavaScript Object Notation \\
\end{abbrList}

\chapter{Úvod}  %TODO odstranit cislo kapitoly
	V mém magisterském projektu jsem řešil problematiku validace konfiguračních souborů pro Flow123d. Tyto soubory mají dynamicky definovanou strukturu, která se liší podle verze Flow123d. Cílem je vytvořit nástroj, který určí, zda zadaný konfigurační soubor je validní pro danou verzi.

	Konfigurační soubory jsou ve formátu CON, který se podobá standardnímu formátu JSON. Od tohoto formátu se mírně odlišuje syntaxí. Konkrétní odlišnosti jsou popsány v kapitole \ref{specifika-con-formatu}. Kromě odlišné syntaxe také umožňuje vytvářet reference, se kterými je potřeba náležitě pracovat při zpracování dat. Práce s referencemi jsou popsány v kapitole \ref{zpracovani-referenci}. Formát CON také umožňuje v některých případech použít zkrácený zápis, který se poté čtečkou formátu automaticky zkonvertuje na požadovaný tvar. Problematikou autokonverzí se zabývá kapitola \ref{autokonverze}.

	Jelikož se struktura konfiguračních souborů se liší podle verze Flow123d, validace nespočívá pouze v ověření dat podle pevně dané struktury. Pro validaci je nutné dynamicky načíst sadu pravidel, která strukturu popisuje. Sada těchto pravidel je dodána ve formátu JSON. V něm se nachází specifikace jednotlivých pravidel, které společně tvoří stromovou strukturu, stejně jako vstupní konfigurační soubor. Problematika použití sady pravidel popisující strukturu je popsána v kapitole \ref{pravidla-pro-popis-struktury}.

\chapter{Formát konfiguračních souborů}
	Konfigurační soubory, které je potřeba zvalidovat, jsou často psány ručně a nejsou strvojově generovány. Formát CON, ve kterém jsou napsány, byl tomuto přizpůsoben. Syntaxe CON je podobná standardnímu formátu JSON, ale pro snažší zápis se mírně liší. Rozdíly v syntaxi oproti formátu JSON jsou následující.
	\begin{itemize}
		\item Klíče neobsahující mezeru mohou být napsány bez uvozovek.
		\item Klíč může být od hodnoty oddělen znakem \uv{\texttt{$=$}} místo \uv{\texttt{$:$}}.
		\item V souboru se mohou vyskytovat komentáře. Jsou povoleny víceřádkové komentáře uzavřené mezi sekvencemi \texttt{/*} a \texttt{*/}, nebo řádkové komentáře, které jsou uvozeny sekvencí \texttt{//}.
	\end{itemize}


	\label{semantika-con}
	Formát CON byl navržen pro inicializaci datových typů v C++. Kromě syntaktických rozdílů tedy předpokládá následující sémantická pravidla.
	\begin{itemize}
		\item Záznam má určitý typ, který definuje seznam povolených klíčů.
		\item Každý klíč má daný typ, jméno a implicitní hodnotu.
		\item Klíče napsané velkými písmeny mají speciální význam a jsou zpracovány čtečkou CON formátu. Názvy ostatních klíčů jsou malými písmeny.
		\item Povolené datové typy jsou skalární hodnoty, pole nebo záznamy.
		\item Pole jsou vždy tvořeny prvky stejného typu.
		\item U záznamů lze použít polymorfismus, kde klíč \texttt{TYPE} udává typ záznamu.
		\item Lze použít reference na data v rámci CON souboru pomocí speciálního klíče \texttt{REF}.
	\end{itemize}

	Bližší specifikace formátu CON lze nalézt v dokumentaci Flow123D. %TODO http://bacula.nti.tul.cz/~jan.brezina/flow123d_packages/1.8.1/flow123d_1.8.1_doc.pdf

	\section{Autokonverze}

	\section{Reference}

\chapter{Struktura konfiguračních souborů}
	Jak již bylo zmíněno v kapitole \ref{semantika-con}, data v konfiguračním soubor podléhají určitým sémantickým pravidlům. Uvedená pravidla jsou pouze obecná a jejich konkrétní podoba je závislá na verzi Flow123D. Požadavky na strukturu jsou popsány v dokumentaci Flow123D a pro potřeby aplikace je jejich specifikace dodána ve strojově čitelném formátu JSON.

	V této kapitole je popsán formát souboru specifikací. Nachází se v něm seznam datových typů, jejich popis, vlastnosti a struktura. Z jednotlivých položek lze vytvořit sada povolených datových typů, které lze použít v konfiguračním souboru. Každý datový typ má specifikované \texttt{id}, které ho jednoznačně identifikuje, a \texttt{input\_type}, který určuje základní datový typ, od kterého je daný typ odvozen. Základními datovými typy jsou skalár (viz tabulka \ref{tab:typy-skalaru}), pole (\textit{Array}), záznam (\textit{Record}) a abstraktní záznam (\textit{AbstractRecord}).

	Data v konfiguračním souboru tvoří stromovou strukturu. Pro jejich ověření se postupuje od kořene stromu k listům. Popis datového typu kořenu stromu je vždy uveden v seznamu jako první. Aby konfigurační soubor odpovídal dané specifikaci, musí být všechny uzly stromu validní. Pokud validní nejsou, zaznamená se, k jaké chybě došlo a kde.

	%Pravidla mohou definovat několik datových typů. Prvními z nich jsou skalární hodnoty. Jejich typy a pravidla pro validaci jsou popsány v tabulce \ref{tab:typy-skalaru}. Dalším datovými typy jsou pole (\textit{Array}), záznam (\textit{Record}) a abstraktní záznam (\textit{AbstractRecord}), který se využívá pro polymorfismus.

	% Aby byl konfigurační soubor validní, musí jeho struktura odpovídat pravidlům, které jsou specifikovány v popisu struktury pro danou verzi. Vstupní data, stejně jako sada pravidel pro validaci, tvoří stromovou strukturu. 

	\begin{table}[h]
		\centering
		\caption{Datové typy skalárních hodnot}
		\label{tab:typy-skalaru}
		\begin{tabular}{|l|l|l|}
		\hline
		\textbf{Základní datový typ} & \textbf{Popis}           & \textbf{Pravidlo pro validaci}                                            \\
		\hline
		\textit{Integer}    & celé číslo      & hodnota musí být v rozmezí \texttt{min} a \texttt{max}               \\
		\textit{Double}     & desetinné číslo & hodnota musí být v rozmezí \texttt{min} a \texttt{max}               \\
		\textit{Bool}       & přepínač        & --                                                  \\
		\textit{String}     & řetězec         & --                                                  \\
		\textit{Selection}  & výběr z množiny & \parbox[t]{7cm}{musí obsahovat hodnotu z množiny povolených hodnot} \\
		\textit{FileName}   & cesta k souboru & --                                                  \\
		\hline
		\end{tabular}
	\end{table}

	\section{Skalární hodnoty}
		U skalárních typů spočívá validace v ověření správného datového typu a ověření validačního pravidla, pokud nějaké existuje. Pro číselné hodnoty se kontroluje rozmezí, které je určeno hodnotami \texttt{min} a \texttt{max} u specifikace datového typu. Speciální validaci vyžaduje také typ \textit{Selection}. U tohoto datového typu je dána množina povolených hodnot (\texttt{values}), kde každá hodnota má jméno (\texttt{name}), které ji jednoznačně identifikuje. Zadaná hodnota v \textit{Selection} je validní, pokud se shoduje se jménem některé z povolených hodnot.

	\section{Pole}
		Typ \textit{Array} má podobně jako číselné typy specifikované hodnoty \texttt{min} a \texttt{max}. U pole tyto hodnoty určují minimální, resp. maximální počet položek. Pravidlo pro validaci pole tedy spočívá v oveření počtu položek pole. Dále je nutné ověřit, zda jsou validní jednotlivé položky v poli. Pole jsou vždy homogenní, tedy všechny jeho položky jsou stejného typu, který je určen pomocí \texttt{subtype}.

	\section{Záznam}
		Typ \textit{Record} má unikátní jméno (\texttt{type\_name}) a obsahuje libovolný počet klíčů. Pokud je potomkem nějakých abstraktních záznamů, tak je jejich seznam uveden v položce \texttt{implements}. Položka \texttt{keys} definuje seznam povolených klíčů. V ní jsou dále uvedeny tyto položky:
		\begin{itemize}
			\item \texttt{key}: definuje název klíče,
			\item \texttt{description}: popis klíče,
			\item \texttt{type}: typ klíče,
			\item \texttt{default}: obsahuje dále \texttt{type}, který určuje typ defaultní hodnoty a \texttt{value} pro implicitní hodnotu.
		\end{itemize}



		Typ defaultní hodnoty může nabývat hodnot \textit{obligatory}, \textit{value at declaration}, \textit{value at read time} a \textit{optional}. Pro potřeby validace je důležitá pouze hodnota \textit{obligatory}, která specifikuje, že klíč musí být v záznamu uveden. Všechny ostatní typy klíčů nemusí být v záznamu uvedeny. Validace záznamů spočívá v oveření, zda jsou přítomny všechny klíče, které jsou povinné (\textit{obligatory}), a dále v oveření typu všech klíčů, které jsou v záznamu uvedené.

	\section{Abstraktní záznam}
		Speciální typ záznamu, který umožňuje polymorfismus, je \textit{AbstractRecord}. Obsahuje položku \texttt{implementations}, ve které jsou uvedeny všechny zázamy, které ho implementují. Další důležitou položkou je \texttt{default\_descendant}. Pokud je uvedena, tak definuje výchozí typ záznamu.

		Při validaci záznamu je nutné nejprve určit jeho typ. K tomu slouží klíč \texttt{TYPE}, který je přímo uveden u daného záznamu v konfiguračním souboru. Pokud tento klíč není uveden, použije se typ, který je určen pomocí \texttt{default\_descendant}. Pokud ani takto nelze určit typ záznamu, jedná se o chybový stav. Po určení typu záznamu se provede validace podĺe pravidel, které definuje přímo konkrétní datový typ. 


\end{document}